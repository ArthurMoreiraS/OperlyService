// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =====================================================
// ENUMS
// =====================================================

enum AppointmentStatus {
  PENDING    // Agendado, aguardando atendimento
  CONFIRMED  // Confirmado pelo estabelecimento
  COMPLETED  // Serviço concluído
  CANCELLED  // Cancelado
  NO_SHOW    // Cliente não compareceu
}

enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum VehicleType {
  HATCH
  SEDAN
  SUV
  PICKUP
  COUPE
  CONVERTIBLE
  VAN
  TRUCK
  MOTORCYCLE
  OTHER
}

// =====================================================
// USER - Proprietário da conta
// =====================================================

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relações
  business Business?

  @@map("users")
}

// =====================================================
// BUSINESS - Estabelecimento de estética automotiva
// =====================================================

model Business {
  id                 String      @id @default(cuid())
  userId             String      @unique @map("user_id")
  name               String
  phone              String?
  address            String?
  slug               String      @unique
  workingDays        DayOfWeek[] @default([MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY]) @map("working_days")
  openTime           String      @default("08:00") @map("open_time") // Formato HH:mm
  closeTime          String      @default("18:00") @map("close_time") // Formato HH:mm
  slotDuration       Int         @default(60) @map("slot_duration") // Duração padrão em minutos
  monthlyRevenueGoal Decimal?    @default(5000) @map("monthly_revenue_goal") @db.Decimal(10, 2) // Meta mensal de faturamento
  isOnboarded        Boolean     @default(false) @map("is_onboarded")
  imageUrl           String?     @map("image_url")
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  // Relações
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  services     Service[]
  customers    Customer[]
  appointments Appointment[]
  invoices     Invoice[]

  @@index([slug])
  @@map("businesses")
}

// =====================================================
// SERVICE - Serviços oferecidos pelo estabelecimento
// =====================================================

model Service {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  duration    Int      @default(60) // Duração em minutos
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relações
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  invoiceItems InvoiceItem[]

  @@index([businessId])
  @@index([businessId, isActive])
  @@map("services")
}

// =====================================================
// CUSTOMER - Clientes do estabelecimento
// =====================================================

model Customer {
  id         String   @id @default(cuid())
  businessId String   @map("business_id")
  name       String
  phone      String
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relações
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  invoices     Invoice[]
  vehicles     Vehicle[]

  @@unique([businessId, phone]) // Um telefone único por estabelecimento
  @@index([businessId])
  @@index([businessId, phone])
  @@map("customers")
}

// =====================================================
// VEHICLE - Veículos do cliente
// =====================================================

model Vehicle {
  id          String      @id @default(cuid())
  customerId  String      @map("customer_id")
  brand       String      // Marca (Volkswagen, Toyota, etc)
  model       String      // Modelo (Gol, Corolla, etc)
  color       String      // Cor
  plate       String?     // Placa (opcional)
  year        Int?        // Ano (opcional)
  type        VehicleType @default(SEDAN)
  isDefault   Boolean     @default(false) @map("is_default") // Veículo principal
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relações
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@index([customerId])
  @@map("vehicles")
}

// =====================================================
// APPOINTMENT - Agendamentos
// =====================================================

model Appointment {
  id           String            @id @default(cuid())
  businessId   String            @map("business_id")
  customerId   String            @map("customer_id")
  serviceId    String            @map("service_id")
  vehicleId    String?           @map("vehicle_id") // Veículo usado no agendamento
  date         DateTime          @db.Date // Apenas a data
  startTime    String            @map("start_time") // Formato HH:mm
  endTime      String            @map("end_time") // Formato HH:mm
  status       AppointmentStatus @default(PENDING)
  isFromPublic Boolean           @default(false) @map("is_from_public") // Veio da página pública
  notes        String?           @db.Text
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  // Relações
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  vehicle  Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  // Relação com fatura (opcional - um agendamento pode gerar uma fatura)
  invoice Invoice?

  @@unique([businessId, date, startTime]) // Previne agendamentos duplicados no mesmo horário
  @@index([businessId])
  @@index([businessId, date])
  @@index([businessId, status])
  @@index([customerId])
  @@map("appointments")
}

// =====================================================
// ENUMS - Billing
// =====================================================

enum InvoiceStatus {
  DRAFT      // Rascunho, ainda não emitida
  PENDING    // Emitida, aguardando pagamento
  PARTIAL    // Parcialmente paga
  PAID       // Totalmente paga
  CANCELLED  // Cancelada
  OVERDUE    // Vencida
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  CASH
  TRANSFER
  OTHER
}

// =====================================================
// INVOICE - Faturas
// =====================================================

model Invoice {
  id            String        @id @default(cuid())
  businessId    String        @map("business_id")
  customerId    String        @map("customer_id")
  appointmentId String?       @unique @map("appointment_id") // Opcional - fatura avulsa

  // Identificação
  number        String        // Número sequencial NF-0001

  // Status e datas
  status        InvoiceStatus @default(DRAFT)
  issuedAt      DateTime?     @map("issued_at")       // Data de emissão
  dueDate       DateTime?     @map("due_date")        // Data de vencimento
  paidAt        DateTime?     @map("paid_at")         // Data do pagamento total

  // Valores
  subtotal      Decimal       @db.Decimal(10, 2)      // Soma dos itens
  discount      Decimal       @default(0) @db.Decimal(10, 2) // Desconto
  total         Decimal       @db.Decimal(10, 2)      // subtotal - discount
  paidAmount    Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2) // Valor já pago

  // Observações
  notes         String?       @db.Text

  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relações
  business    Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer    Customer      @relation(fields: [customerId], references: [id], onDelete: Restrict)
  appointment Appointment?  @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  items       InvoiceItem[]
  payments    Payment[]

  @@unique([businessId, number])
  @@index([businessId])
  @@index([businessId, status])
  @@index([businessId, issuedAt])
  @@index([customerId])
  @@map("invoices")
}

// =====================================================
// INVOICE_ITEM - Itens da Fatura
// =====================================================

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String   @map("invoice_id")
  serviceId   String?  @map("service_id") // Opcional - pode ser item avulso

  description String   // Nome do serviço ou descrição do item
  quantity    Int      @default(1)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2) // quantity * unitPrice

  createdAt   DateTime @default(now()) @map("created_at")

  // Relações
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@map("invoice_items")
}

// =====================================================
// PAYMENT - Pagamentos
// =====================================================

model Payment {
  id        String        @id @default(cuid())
  invoiceId String        @map("invoice_id")

  amount    Decimal       @db.Decimal(10, 2)
  method    PaymentMethod
  paidAt    DateTime      @default(now()) @map("paid_at")
  notes     String?       @db.Text

  createdAt DateTime      @default(now()) @map("created_at")

  // Relações
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([invoiceId, paidAt])
  @@map("payments")
}
